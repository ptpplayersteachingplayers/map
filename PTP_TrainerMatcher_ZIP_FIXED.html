
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PTP Trainer Matcher</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f9f9f9; }
    header { background: #000; color: #fff; text-align: center; padding: 30px 20px; }
    header h1 { margin: 0; font-size: 2rem; }
    #controls { text-align: center; padding: 20px; background: #fff; }
    #zipInput { padding: 10px; font-size: 16px; width: 240px; margin-right: 10px; }
    #searchButton { padding: 10px 16px; background: #FFD700; border: none; font-size: 16px; cursor: pointer; border-radius: 5px; }
    #map { width: 100%; height: 600px; }
    #stickyCTA { display: none; position: fixed; bottom: 0; width: 100%; background: #FFD700; text-align: center; padding: 14px; font-weight: bold; z-index: 999; }
    @media (max-width: 768px) { #stickyCTA { display: block; } }
    .list-view { padding: 20px; }
    .field-block { background: #fff; border-left: 5px solid #FFD700; padding: 15px; margin-bottom: 20px; border-radius: 6px; }
    .trainer { padding-left: 10px; margin: 8px 0; border-left: 2px solid #ccc; }
    .rating { color: #FFD700; font-size: 16px; }
    .fav-btn { float: right; cursor: pointer; font-size: 18px; color: red; }
    .field-img { width: 100%; max-width: 300px; margin: 10px 0; border-radius: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>Find a Field & Book Your PTP Trainer</h1>
    <p>Search your ZIP, explore fields, and save your favorites.</p>
  </header>
  <div id="controls">
    <input type="text" id="zipInput" placeholder="Enter ZIP Code" />
    <button id="searchButton" onclick="search()">Search</button>
  </div>
  <div id="map"></div>
  <div id="stickyCTA">üìÖ Book a Trainer Now</div>
  <div class="list-view" id="listView"></div>

  <script>
    let map, trainerData = [];
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSClTYNvQo15rYGb6Au-Uxk84CxTuJ1Q5sLEhXd2ReLm0JyUbhQhOMSi1-I50hf3Rs4TArW6gmgbqfa/pub?gid=2095822811&single=true&output=csv";
    const icon = "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png";

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 40, lng: -75.3 },
        zoom: 10,
      });
      fetchData();
    }

    function fetchData() {
      fetch(csvUrl)
        .then(res => res.text())
        .then(data => {
          const lines = data.split("\n").slice(1);
          const fieldMap = new Map();
          lines.forEach(line => {
            const [fieldName, address, zip, city, name, link, availability, bio, rating, review, image] = line.split(",");
            if (!fieldName || !name) return;
            const key = fieldName + zip;
            if (!fieldMap.has(key)) {
              fieldMap.set(key, { fieldName, address, zip, city, image, trainers: [] });
            }
            fieldMap.get(key).trainers.push({ name, link, availability, bio, rating, review });
          });
          trainerData = Array.from(fieldMap.values());
        });
    }

    
    function search() {
      if (!trainerData || trainerData.length === 0) {
        alert("Trainer data is still loading. Please wait a moment and try again.");
        return;
      }
    
      const zip = document.getElementById("zipInput").value.trim();
      const geo = new google.maps.Geocoder();
      geo.geocode({ address: zip }, (results, status) => {
        if (status === "OK") {
          const userLoc = results[0].geometry.location;
          map.setCenter(userLoc);
          map.setZoom(11);
          renderMap(userLoc);
        }
      });
    }

    function renderMap(centerLoc) {
      const geo = new google.maps.Geocoder();
      const bounds = new google.maps.LatLngBounds();
      const list = document.getElementById("listView");
      list.innerHTML = "";

      trainerData.forEach(field => {
        geo.geocode({ address: field.address || field.zip }, (results, status) => {
          if (status === "OK") {
            const loc = results[0].geometry.location;
            bounds.extend(loc);

            const marker = new google.maps.Marker({ map, position: loc, title: field.fieldName, icon });
            const fieldImg = field.image ? `<img src="${field.image}" class='field-img' />` :
              `<iframe width="100%" height="200" style="border-radius:6px;" loading="lazy"
               src="https://www.google.com/maps/embed/v1/streetview?key=AIzaSyASLf8mjb8iEbVo99DnaaPzXGlu5jhXrZE&location=${loc.lat()},${loc.lng()}&heading=210&pitch=10&fov=35"></iframe>`;

            let popup = `<strong>${field.fieldName}</strong><br><small>${field.address}</small><br>${fieldImg}<br>`;
            field.trainers.forEach(t => {
              popup += `
                <div style="margin:10px 0">
                  <strong>${t.name}</strong>
                  <span class='fav-btn' onclick="saveFav('${t.name}')">‚ù§Ô∏è</span><br>
                  ${starRating(t.rating)} ${t.review ? `<br><em>"${t.review}"</em>` : ""}
                  <br><small>${t.bio}</small><br>
                  <b>Availability:</b> ${t.availability}<br>
                  <a href="${t.link}" target="_blank">Book</a>
                </div><hr>`;
            });

            const info = new google.maps.InfoWindow({ content: popup });
            marker.addListener("click", () => info.open(map, marker));

            // List View
            let html = `<div class='field-block'>
              <h3>${field.fieldName} ‚Äì ${field.city}</h3>
              <p><strong>Address:</strong> ${field.address}</p>
              ${fieldImg}`;
            field.trainers.forEach(t => {
              html += `<div class='trainer'>
                <strong>${t.name}</strong>
                <span class='fav-btn' onclick="saveFav('${t.name}')">‚ù§Ô∏è</span><br>
                ${starRating(t.rating)} ${t.review ? `<br><em>"${t.review}"</em>` : ""}
                <br>${t.bio}<br><b>Availability:</b> ${t.availability}<br>
                <a href="${t.link}" target="_blank">Book</a>
              </div>`;
            });
            html += `</div>`;
            list.innerHTML += html;
          }
        });
      });
    }

    function starRating(val) {
      const v = Math.round(parseFloat(val));
      return `<span class='rating'>${"‚òÖ".repeat(v)}${"‚òÜ".repeat(5 - v)}</span>`;
    }

    function saveFav(name) {
      const saved = JSON.parse(localStorage.getItem("favorites") || "[]");
      if (!saved.includes(name)) saved.push(name);
      localStorage.setItem("favorites", JSON.stringify(saved));
      alert(`${name} saved to favorites`);
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASLf8mjb8iEbVo99DnaaPzXGlu5jhXrZE&callback=initMap"></script>
</body>
</html>
